{% extends "base.html" %}

{% block title %}Experiments - SWE-bench Benchmark{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>All Experiments</h2>
    <button onclick="openCreateModal()" class="btn btn-primary">+ New Experiment</button>
</div>

<!-- Create Experiment Modal -->
<div id="createModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-bottom: 20px;">Create New Experiment</h2>
        <form id="createForm" onsubmit="createExperiment(event)">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Name *</label>
                <input type="text" name="name" required style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 6px;" placeholder="My Experiment">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description</label>
                <textarea name="description" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 6px; min-height: 60px;" placeholder="Optional description"></textarea>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Providers *</label>
                <div style="display: flex; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" name="providers" value="openai" checked> OpenAI
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" name="providers" value="anthropic" checked> Anthropic
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" name="providers" value="google" checked> Google
                    </label>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Dataset Split *</label>
                <select name="split" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 6px;">
                    <option value="dev">dev (23 instances) - Quick testing</option>
                    <option value="lite">lite (300 instances) - SWE-bench Lite</option>
                    <option value="test">test (2294 instances) - Full SWE-bench</option>
                    <option value="verified">verified (500 instances) - Human-verified subset</option>
                </select>
                <small style="color: var(--gray-600);">Start with 'dev' for testing, use 'lite' for thesis results</small>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Instance Limit</label>
                <input type="number" name="limit" value="10" min="1" max="2294" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 6px;">
                <small style="color: var(--gray-600);">Number of instances to run (leave high to run all)</small>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tool Set</label>
                <select name="tool_set" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 6px;">
                    <option value="all_tools">All Tools (read_file, search_code, list_directory)</option>
                    <option value="no_search">No Search (read_file, list_directory)</option>
                    <option value="file_only">File Only (read_file)</option>
                    <option value="no_tools">No Tools</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Max Concurrent</label>
                <input type="number" name="max_concurrent" value="3" min="1" max="10" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 6px;">
                <small style="color: var(--gray-600);">Parallel requests per provider</small>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeCreateModal()" class="btn" style="background: var(--gray-100);">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Experiment</button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    {% if experiments %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Split</th>
                <th>Status</th>
                <th>Progress</th>
                <th>Providers</th>
                <th>Tool Sets</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for exp in experiments %}
            <tr>
                <td>
                    <a href="/dashboard/experiments/{{ exp.id }}" style="color: var(--primary); text-decoration: none; font-weight: 500;">
                        {{ exp.name }}
                    </a>
                </td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                    {{ exp.description or '-' }}
                </td>
                <td>
                    <span class="badge" style="background: {% if exp.config.split == 'lite' %}var(--primary){% elif exp.config.split == 'dev' %}var(--gray-200){% else %}var(--warning){% endif %}; {% if exp.config.split == 'lite' %}color: white;{% endif %}">
                        {{ exp.config.split or 'dev' }}
                    </span>
                </td>
                <td>
                    <span class="badge badge-{{ exp.status.value }}">{{ exp.status.value }}</span>
                </td>
                <td style="width: 150px;">
                    <div class="progress-bar">
                        {% set progress = (exp.completed_instances / exp.total_instances * 100) if exp.total_instances > 0 else 0 %}
                        <div class="fill" style="width: {{ progress }}%"></div>
                    </div>
                    <small style="color: var(--gray-600);">{{ exp.completed_instances }} / {{ exp.total_instances }}</small>
                </td>
                <td>
                    {% for p in exp.config.providers %}
                    <span class="badge" style="background: var(--gray-100);">{{ p }}</span>
                    {% endfor %}
                </td>
                <td>
                    {% for ts in exp.config.tool_sets %}
                    <span class="badge" style="background: var(--gray-100);">{{ ts.name }}</span>
                    {% endfor %}
                </td>
                <td>{{ exp.created_at.strftime('%Y-%m-%d') }}</td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        <a href="/dashboard/experiments/{{ exp.id }}" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.875rem;">View</a>
                        {% if exp.status.value == 'pending' or exp.status.value == 'paused' %}
                        <button onclick="startExperiment('{{ exp.id }}')" class="btn btn-success" style="padding: 6px 12px; font-size: 0.875rem;">Start</button>
                        {% elif exp.status.value == 'running' %}
                        <button onclick="stopExperiment('{{ exp.id }}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.875rem;">Stop</button>
                        {% endif %}
                        {% if exp.status.value == 'completed' or exp.completed_instances > 0 %}
                        <div style="position: relative; display: inline-block;">
                            <button onclick="toggleEvalMenu('{{ exp.id }}')" class="btn" style="padding: 6px 12px; font-size: 0.875rem; background: var(--warning); color: white;">Eval ‚ñæ</button>
                            <div id="evalMenu-{{ exp.id }}" class="eval-menu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--gray-200); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; min-width: 200px;">
                                <button onclick="evaluateSWEBench('{{ exp.id }}')" class="eval-option">üê≥ SWE-bench</button>
                                <button onclick="evaluateQuick('{{ exp.id }}')" class="eval-option">‚ö° Quick</button>
                            </div>
                        </div>
                        {% endif %}
                        {% if exp.status.value != 'running' %}
                        <button onclick="deleteExperiment('{{ exp.id }}', '{{ exp.name }}')" class="btn" style="padding: 6px 12px; font-size: 0.875rem; background: var(--gray-100); color: var(--danger);">Delete</button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <h3>No experiments yet</h3>
        <p>Click "+ New Experiment" to create your first experiment</p>
        <pre style="background: var(--gray-100); padding: 20px; border-radius: 8px; text-align: left; display: inline-block; margin-top: 20px;">
POST /api/v1/benchmark/experiments
{
  "name": "My First Experiment",
  "providers": ["openai", "anthropic", "google"],
  "split": "dev",  // or "lite" for thesis
  "limit": 10
}</pre>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Modal functions
function openCreateModal() {
    document.getElementById('createModal').style.display = 'flex';
}

function closeCreateModal() {
    document.getElementById('createModal').style.display = 'none';
    document.getElementById('createForm').reset();
}

// Close modal when clicking outside
document.getElementById('createModal').addEventListener('click', function(e) {
    if (e.target === this) closeCreateModal();
});

// Tool set configurations
const toolSets = {
    'all_tools': ['read_file', 'search_code', 'list_directory'],
    'no_search': ['read_file', 'list_directory'],
    'file_only': ['read_file'],
    'no_tools': []
};

async function createExperiment(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    // Get selected providers
    const providers = [];
    form.querySelectorAll('input[name="providers"]:checked').forEach(cb => {
        providers.push(cb.value);
    });

    if (providers.length === 0) {
        alert('Please select at least one provider');
        return;
    }

    // Build tool sets based on selection
    const toolSetName = formData.get('tool_set');
    const toolSetConfig = {
        name: toolSetName,
        enabled_tools: toolSets[toolSetName]
    };

    const payload = {
        name: formData.get('name'),
        description: formData.get('description') || null,
        providers: providers,
        split: formData.get('split'),
        limit: parseInt(formData.get('limit')),
        max_concurrent: parseInt(formData.get('max_concurrent')),
        tool_sets: [toolSetConfig]
    };

    try {
        const response = await fetch('/api/v1/benchmark/experiments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const data = await response.json();
            closeCreateModal();
            location.reload();
        } else {
            const error = await response.json();
            alert('Failed to create experiment: ' + (error.detail || 'Unknown error'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function startExperiment(id) {
    try {
        const response = await fetch(`/api/v1/benchmark/experiments/${id}/start`, {
            method: 'POST'
        });
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to start experiment');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function stopExperiment(id) {
    try {
        const response = await fetch(`/api/v1/benchmark/experiments/${id}/stop`, {
            method: 'POST'
        });
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to stop experiment');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function deleteExperiment(id, name) {
    if (!confirm(`Are you sure you want to delete "${name}"?\n\nThis will permanently delete all results and test data.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/v1/benchmark/experiments/${id}`, {
            method: 'DELETE'
        });
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('Failed to delete: ' + (error.detail || 'Unknown error'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

function toggleEvalMenu(id) {
    // Close all other menus first
    document.querySelectorAll('.eval-menu').forEach(menu => {
        if (menu.id !== 'evalMenu-' + id) {
            menu.style.display = 'none';
        }
    });
    const menu = document.getElementById('evalMenu-' + id);
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// Close menus when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.eval-menu') && !e.target.closest('[onclick^="toggleEvalMenu"]')) {
        document.querySelectorAll('.eval-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

async function evaluateQuick(id) {
    document.querySelectorAll('.eval-menu').forEach(m => m.style.display = 'none');

    if (!confirm('Start Quick Evaluation?\n\nNote: Tests may fail due to environment issues.')) return;

    try {
        const response = await fetch(`/api/v1/benchmark/experiments/${id}/evaluate`, { method: 'POST' });
        if (response.ok) {
            alert('Quick evaluation started! Refresh later to see results.');
        } else {
            const error = await response.json();
            alert('Failed: ' + (error.detail || 'Unknown error'));
        }
    } catch (e) { alert('Error: ' + e.message); }
}

async function evaluateSWEBench(id) {
    document.querySelectorAll('.eval-menu').forEach(m => m.style.display = 'none');

    if (!confirm('Start SWE-bench Evaluation?\n\n‚ö†Ô∏è Requires Docker (downloads ~67GB first run).\n\nThis uses the official harness for accurate results.')) return;

    try {
        const response = await fetch(`/api/v1/benchmark/experiments/${id}/evaluate-swebench`, { method: 'POST' });
        const data = await response.json();
        if (response.ok) {
            alert(`SWE-bench started! Patches: ${data.patches_to_evaluate}. Check terminal for progress.`);
        } else {
            alert('Failed: ' + (data.detail || 'Unknown error'));
        }
    } catch (e) { alert('Error: ' + e.message); }
}
</script>

<style>
.eval-option {
    width: 100%;
    padding: 10px 12px;
    text-align: left;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 0.875rem;
}
.eval-option:hover {
    background: var(--gray-100);
}
.eval-option:not(:last-child) {
    border-bottom: 1px solid var(--gray-100);
}
</style>
{% endblock %}
